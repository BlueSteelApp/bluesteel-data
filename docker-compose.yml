version: "2"

services:
  mysql:
    image: "mysql:5.7"
    ports:
    - "3306:3306"
    environment:
    - "MYSQL_ALLOW_EMPTY_PASSWORD=yes"
    - "MYSQL_DATABASE=dev"
    - "MYSQL_USER=dev"
    - "MYSQL_PASSWORD=dev"
    volumes:
    - mysql:/var/lib/mysql

  redis:
    image: "redis:3.0"
    ports:
    - "6379:6379"

  bluesteel-migrate:
    image: "node:13.2"
    working_dir: /home/node/app
    volumes:
    - "./:/home/node/app"
    command: "node ./modules/migrate"
    environment:
    - "DATABASE_HOST=mysql"
    - "DATABASE_NAME=dev"
    - "DATABASE_USER=dev"
    - "DATABASE_PASSWORD=dev"

  bluesteel-job-manager:
    image: "node:13.2"
    working_dir: /home/node/app
    volumes:
    - "./:/home/node/app"
    command: "node_modules/nodemon/bin/nodemon ./jobs-manager/cli manager"
    environment:
    - "JOB_MANAGER_REDIS_URI=redis://redis:6379"
    - "BLUESTEEL_JOB_QUEUE_TYPE=bull"
    - "BLUESTEEL_JOB_QUEUE_JOB_LIMIT=10"
    - "DATABASE_HOST=mysql"
    - "DATABASE_NAME=dev"
    - "DATABASE_USER=dev"
    - "DATABASE_PASSWORD=dev"

  bluesteel-job-client:
    image: "node:13.2"
    working_dir: /home/node/app
    volumes:
    - "./:/home/node/app"
    command: "node_modules/nodemon/bin/nodemon ./jobs-manager/cli client"
    environment:
    - "JOB_MANAGER_REDIS_URI=redis://redis:6379"
    - "BLUESTEEL_JOB_QUEUE_TYPE=bull"
    - "BLUESTEEL_JOB_QUEUE_JOB_LIMIT=10"

  bluesteel-core:
    image: "node:13.2"
    ports:
    - "5000:5000"
    working_dir: /home/node/app
    volumes:
    - "./:/home/node/app"
    command: "node_modules/nodemon/bin/nodemon ./app/"
    stop_signal: "-9"
    environment:
    - "DATABASE_HOST=mysql"
    - "DATABASE_NAME=dev"
    - "DATABASE_USER=dev"
    - "DATABASE_PASSWORD=dev"

volumes:
  mysql:
